<html>
<head>	
	<title>River Basin</title>

	<meta charset="utf-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!--
    <script src="https://code.jquery.com/jquery-3.5.1.min.js" integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0=" crossorigin="anonymous"></script>
        -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" integrity="sha512-xodZBNTC5n17Xt2atTPuE1HxjVMSvLVW9ocqUKLsCC5CXdbqCmblAshOMAS6/keqq/sMZMZ19scR4PsZChSR7A==" crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js" integrity="sha512-XQoYMqMTK8LvdxXYG3nZ448hOEQiglfqkJs1NOQV44cWnUrBc8PkAOcXy20w0vlaXaVUearIOBhiXZ5V3ynxwA==" crossorigin=""></script>
	
    <script
    src="https://code.jquery.com/jquery-3.5.1.min.js"
    integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0="
    crossorigin="anonymous"></script>

    <style>
        .info {
            padding: 6px 8px;
            font: 14px/16px Arial, Helvetica, sans-serif;
            background: white;
            background: rgba(255,255,255,0.8);
            box-shadow: 0 0 15px rgba(0,0,0,0.2);
            border-radius: 5px;
        }
        .info h4 {
            margin: 0 0 5px;
            color: #777;
        }
        .legend {
            line-height: 18px;
            color: #555;
        }
        .legend i {
            width: 18px;
            height: 18px;
            float: left;
            margin-right: 8px;
            margin-bottom: 2px;
            opacity: 0.7;
        }
    </style>
   
</head>
<body>

<div id="mapid">
</div>
<script>
    var getParams = function (url) {
        var params = {};
        var parser = document.createElement('a');
        parser.href = url;
        var query = parser.search.substring(1);
        var vars = query.split('&');
        for (var i = 0; i < vars.length; i++) {
            var pair = vars[i].split('=');
            params[pair[0]] = decodeURIComponent(pair[1]);
        }
        return params;
    };

    var params = getParams(window.location.href);
	//var mymap = L.map('mapid').setView([52.123582, -106.66214], 9);

    var map_div = document.querySelector('#mapid');
    width_height_str = 'width: ' + (this.innerWidth-20) + "; height: " + (this.innerHeight-20);
    map_div.setAttribute('style', width_height_str);

    var saskatoon = L.marker([52.133909518197136, -106.66351318359375]).bindPopup('Saskatoon');
    var regina = L.marker([	50.4527, -104.6194]).bindPopup('Regina');
    var prince_albert = L.marker([53.20459312100394, -105.74821472167969]).bindPopup('Prince Albert');
    var north_battleford = L.marker([52.780339216, -108.30047607421875]).bindPopup('North Battleford');

    var cities = L.layerGroup([saskatoon, regina, prince_albert]);
    cities.addLayer(north_battleford);

    var overlayMaps = {
        "Cities": cities
    };

    var legend_text = [">= 100,000", "10,000-100,000", "1,000-10,000", "100-1,000", "10-100", "1-10", "0.1-1", "0.01-0.1", "0.001-0.01", "< 0.001"];
    var layers = [];
    for(var i=0; i< legend_text.length; i++){
        layers.push(L.layerGroup());
    }


    var mbAttr = 'Map data &copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors, ' +
			'Imagery Â© <a href="https://www.mapbox.com/">Mapbox</a>',
    mbUrl = 'https://api.mapbox.com/styles/v1/{id}/tiles/{z}/{x}/{y}?access_token=pk.eyJ1IjoibWFwYm94IiwiYSI6ImNpejY4NXVycTA2emYycXBndHRqcmZ3N3gifQ.rJcFIG214AriISLbB6B5aw';

    var grayscale   = L.tileLayer(mbUrl, {id: 'mapbox/light-v9', tileSize: 512, zoomOffset: -1, attribution: mbAttr}),
        streets  = L.tileLayer(mbUrl, {id: 'mapbox/streets-v11', tileSize: 512, zoomOffset: -1, attribution: mbAttr});
    
    var map = L.map('mapid', {
        center: [52.123582, -106.66214],
        zoom: 9,
        layers: [grayscale, cities]
    });

    var baseLayers = {
        "Grayscale": grayscale,
        "Streets": streets
    };

    color_list = [];

    L.control.layers(baseLayers, overlayMaps).addTo(map);

    var legend = L.control({position: 'bottomleft'});
    legend.onAdd = function(m){
        var div = L.DomUtil.create('div', 'info legend');
        div.innerHTML += "<p>Average discharge <br>in cubic meter / s</p>"
        for(var i=0; i<color_list.length; i++)
        {
            div.innerHTML += '<div style="margin-bottom: 2px;"><i style="background:' + color_list[i] + '; opacity:1"></i>' + legend_text[i] + '</div>';
        }
        return div;
    }

    

    /*
    var websocket = new WebSocket("ws://127.0.0.1:5678/");
    websocket.onmessage = function (event) {
        data = JSON.parse(event.data);
        console.log(data);
        if(data.refresh)
            location.reload();
        
        drawMap(data.json_file, data.color_list);
    }; 
    */

    
    
    var demo_color_list = ["#e31a1c", "#ff7f00", "#6a3d9a", "#1f78b4", "#33a02c", "#fb9a99", "#fdbf6f", "#cab2d6", "#a6cee3", "#b2df8a"];
    //var demo_color_list_seq = ["#ffffff", "#08306b", "#08519c", "#2171b5", "#4292c6", "#6baed6", "#9ecae1", "#c6dbef", "#deebf7", "#f7fbff" ];
    //demo_color_sequential = [];

    //drawMap("jeoJSON_na_30s_saskatoon.json", demo_color_list);
    //drawMap("jeoJSON_na_30_saskatchewan.json", demo_color_list);
    geojsons = params.geojson.split(',');
    for(var i=0; i< geojsons.length; i++)
    {
        drawMap(geojsons[i], demo_color_list);
    }

    function drawMap(json_path, c_list){
        color_list = c_list;
        if(json_path != ''){
            fetch(json_path)
                .then(function(response){
                    return response.json();
                })
                .then(function(data){
                    //console.log(data);
                    
                    L.geoJSON(data, {
                        style: function (feature) {
                            cus_color = color_list[feature.properties.ORD_FLOW - 1];
                            return {color: cus_color};
                        },
                        onEachFeature: function(feature, layer){
                            //console.log(feature);
                            layers[feature.properties.ORD_FLOW-1].addLayer(layer);
                        }
                    }).bindPopup(function (data) {
                        return "Average discharge: " + legend_text[data.feature.properties.ORD_FLOW-1];
                    }).addTo(map);
                    

                    /*
                    var activeLayer = L.geoJson(data, {
                        filter: function(feature, layer) {
                            return (feature.properties.ORD_FLOW == 4);
                        }
                    }).addTo(map);
                    */

                    legend.addTo(map);

                    for(var i=0; i<legend_text.length; i++)
                    {
                        overlayMaps[legend_text[i]] = layers[i];
                        layers[i].addTo(map);
                    }
                    $('.leaflet-control-layers').remove();
                    L.control.layers(baseLayers, overlayMaps).addTo(map);

                });

        }
        
    };
</script>



</body>
</html>