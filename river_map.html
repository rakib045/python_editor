<html>
<head>	
	<title>River Flow</title>

	<meta charset="utf-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!--
    <script src="https://code.jquery.com/jquery-3.5.1.min.js" integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0=" crossorigin="anonymous"></script>
        -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" integrity="sha512-xodZBNTC5n17Xt2atTPuE1HxjVMSvLVW9ocqUKLsCC5CXdbqCmblAshOMAS6/keqq/sMZMZ19scR4PsZChSR7A==" crossorigin=""/>
    <link href="http://maxcdn.bootstrapcdn.com/font-awesome/4.1.0/css/font-awesome.min.css" rel="stylesheet">
    <link rel="stylesheet" href="Style/leaflet-sidebar.css" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-BmbxuPwQa2lc/FVzBcNJ7UAyJxM6wuqIj61tLrc4wSX0szH/Ev+nYRRuWlolflfl" crossorigin="anonymous">
   
    
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js" integrity="sha512-XQoYMqMTK8LvdxXYG3nZ448hOEQiglfqkJs1NOQV44cWnUrBc8PkAOcXy20w0vlaXaVUearIOBhiXZ5V3ynxwA==" crossorigin=""></script>
	
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"
    integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0="
    crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/6.6.2/d3.min.js" integrity="sha512-L2eTGYYQqzK5YozYyUVrJKj2ZRnHE3QzV1+1yY6VXHExStF3potRZyEcD/B6sTOe04xYxB21QNLmVTQFcgwovg==" crossorigin="anonymous"></script>
    <script src="https://d3js.org/d3-queue.v3.min.js"></script>
    <script src="Scripts/leaflet-sidebar.js"></script>
    <script src="Scripts/easyPrint.js"></script>
    <script src="Scripts/box-heatmap.js"></script>
    <script src="Scripts/animated-line-chart.js"></script>
    <script src="Scripts/showMetaData.js"></script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta2/dist/js/bootstrap.bundle.min.js" integrity="sha384-b5kHyXgcpbZJO/tY9Ul7kGkf1S0CWuKcCD38l8YkeH8z8QjE0GmW1gYU5S9FOnJ0" crossorigin="anonymous"></script>
    

    <style>
        .info {
            padding: 6px 8px;
            font: 14px/16px Arial, Helvetica, sans-serif;
            background: white;
            background: rgba(255,255,255,0.8);
            box-shadow: 0 0 15px rgba(0,0,0,0.2);
            border-radius: 5px;
        }
        .info h4 {
            margin: 0 0 5px;
            color: #777;
        }
        .legend {
            line-height: 18px;
            color: #555;
        }
        .legend i {
            width: 18px;
            height: 18px;
            float: left;
            margin-right: 8px;
            margin-bottom: 2px;
            opacity: 0.7;
        }

      rect.bordered {
        stroke: black;
        stroke-width:2px;   
      }

      text.mono {
        font-size: 9pt;
        font-family: Consolas, courier;
        fill: #aaa;
      }

      text.axis-workweek {
        fill: #000;
      }

      text.axis-worktime {
        fill: #000;
      }

      body {
            padding: 0;
            margin: 0;
        }

        html, body, #map {
            height: 100%;
            font: 10pt "Helvetica Neue", Arial, Helvetica, sans-serif;
        }

        .lorem {
            font-style: italic;
            text-align: justify;
            color: #AAA;
        }

        div.tooltip {
            position: absolute;
            text-align: center;
            width: 100px;
            height: 60px;
            padding: 2px;
            font: 12px sans-serif;
            background: white;
            border: 2px solid black;
            border-radius: 5px;
            pointer-events: none;
            }

        div.tooltip1 {
            position: absolute;
            text-align: center;
            width: 100px;
            height: 60px;
            padding: 2px;
            font: 12px sans-serif;
            background: white;
            border: 2px solid black;
            border-radius: 5px;
            pointer-events: none;
            }

            .easyPrintHolder .a3CssClass { 
                background-image: url(data:image/svg+xml;utf8;base64,PD9...go=);
            }
    </style>
   
</head>
<body>
    <div id="sidebar" class="leaflet-sidebar collapsed">

        <!-- nav tabs -->
        <div class="leaflet-sidebar-tabs">
            <!-- top aligned tabs -->
            <ul role="tablist">
                <li><a href="#home" role="tab"><i class="fa fa-bars active" style="padding-top: 12px;"></i></a></li>
            </ul>
        </div>

        <!-- panel content -->
        <div class="leaflet-sidebar-content">
            <div class="leaflet-sidebar-pane" id="home">
                <h1 class="leaflet-sidebar-header">
                    Shape Details
                    <span class="leaflet-sidebar-close"><i class="fa fa-caret-left" style="padding-top: 12px;"></i></span>
                </h1>

                <div style="border: 2px solid black; margin: 10px 5px;border-radius: 5px;padding: 0px 5px 10px 10px;">
                    <h3 id="segment_info">Details Information</h3>
                    <div id="meta_info_div"></div>
                </div>

            </div>
            <div id="historyHeatMap"></div>
        </div>
    </div>

    <div id="mapid">
    </div>

    <div class="modal" tabindex="-1" id="loadingModal">
        <div class="modal-dialog">
          <div class="modal-content">
            <div class="modal-body">
                <div class="text-center">
                    <div class="spinner-border text-info" role="status" style="width: 100px; height:100px; margin: 35px 5px">
                        <span class="visually-hidden">Loading...</span>
                    </div>

                    <br/>
                    <p id="generalMsg" style="font-family: areal; font-size: 15px; padding: 15px 0px;"></p>
                    <span id="loading_info_details">
                        <br/>                                              
                        <div class="progress">
                            <div id="loadingProgress" class="progress-bar progress-bar-striped bg-info" role="progressbar" style="width: 0%" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
                        </div>

                        <p style="font-family: areal; font-size: 15px; padding: 15px 0px;"><span id="shapeLoadedFileCount"></span>/<span id="shapeTotalFileCount"></span> shape files loaded</p>
                    </span>

                    
                </div>
            </div>
          </div>
        </div>
    </div>

<script>
    var getParams = function (url) {
        var params = {};
        var parser = document.createElement('a');
        parser.href = url;
        var query = parser.search.substring(1);
        var vars = query.split('&');
        for (var i = 0; i < vars.length; i++) {
            var pair = vars[i].split('=');
            params[pair[0]] = decodeURIComponent(pair[1]);
        }
        return params;
    };
    color_list = [];
    var data_list = [];    
    //var default_color_list = [ "#b2df8a", "#a6cee3", "#cab2d6", "#fdbf6f", "#fb9a99", "#33a02c", "#1f78b4", "#6a3d9a", "#ff7f00", "#e31a1c"];
    //var default_color_list = [ '#ffffd9','#edf8b1','#c7e9b4','#7fcdbb','#41b6c4','#1d91c0','#225ea8','#253494','#081d58','#000000'];
    var default_color_list = [ '#deebf7', '#c6dbef', '#9ecae1', '#6baed6', '#4292c6', '#2171b5', '#08519c', '#08306b', '#02214f', '#000000'];
    
    var geojsons = "";
    
    var minVal = 0;
    var maxVal = 0;
    var custom_grades = [];
    var quantizeScale = d3.scaleQuantize();
    var geoJsonData;
    var geoJsonFeature;
    var IRFroutedRunoff_data = {};

    

    var loadingModal = new bootstrap.Modal(document.getElementById('loadingModal'), {
        keyboard: false,
        backdrop: 'static',
        focus: true
    });

    var params = getParams(window.location.href);
    if(params.name)
        sessionStorage.setItem("chart_name", params.name);
    
        if(params.colorlist == undefined){
        color_list = default_color_list;
    }
    else{
        colors = params.colorlist.split(',');
        for(var i=0; i< colors.length; i++)
        {
            color_list.push(colors[i]);
        }
    }
    sessionStorage.setItem("colorlist", color_list);

    if(params.geojson != undefined){
        jsons = params.geojson.split(',');
        for(var i=0; i< jsons.length; i++)
        {
            if(i != 0)
                geojsons += ",";

            geojsons += jsons[i];
            //drawMap(geojsons[i], color_list);
        }
    }
    sessionStorage.setItem("geojson", geojsons);

	//var mymap = L.map('mapid').setView([52.123582, -106.66214], 9);

    var map_div = document.querySelector('#mapid');
    width_height_str = 'width: ' + (this.innerWidth-20) + "; height: " + (this.innerHeight-20);
    map_div.setAttribute('style', width_height_str);

    //var saskatoon = L.marker([52.133909518197136, -106.66351318359375]).bindPopup('Saskatoon');
    //var regina = L.marker([	50.4527, -104.6194]).bindPopup('Regina');
    //var prince_albert = L.marker([53.20459312100394, -105.74821472167969]).bindPopup('Prince Albert');
    //var north_battleford = L.marker([52.780339216, -108.30047607421875]).bindPopup('North Battleford');

    //var cities = L.layerGroup([saskatoon, regina, prince_albert]);
    //cities.addLayer(north_battleford);

    var overlayMaps = {
        //"Cities": cities
    };

    var legend_text = [];
    //var layers = [];
    
    var mbAttr = 'Map data &copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors, ' +
			'Imagery Â© <a href="https://www.mapbox.com/">Mapbox</a>',
    mbAttrS = 'Tiles &copy; Esri &mdash; Source: Esri, i-cubed, USDA, USGS, AEX, GeoEye, Getmapping, Aerogrid, IGN, IGP, UPR-EGP, and the GIS User Community',
    mbUrl = 'https://api.mapbox.com/styles/v1/{id}/tiles/{z}/{x}/{y}?access_token=pk.eyJ1IjoibWFwYm94IiwiYSI6ImNpejY4NXVycTA2emYycXBndHRqcmZ3N3gifQ.rJcFIG214AriISLbB6B5aw',
    mbUrlS = 'https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}';

    var grayscale   = L.tileLayer(mbUrl, {id: 'mapbox/light-v9', tileSize: 512, zoomOffset: -1, attribution: mbAttr}),
        streets  = L.tileLayer(mbUrl, {id: 'mapbox/streets-v11', tileSize: 512, zoomOffset: -1, attribution: mbAttr}),
        sattelite = L.tileLayer(mbUrlS, {id: 'mapbox.streets', attribution: mbAttrS});
   var map;
   var sidebar;

    var baseLayers = {
        "Grayscale": grayscale,
        "Streets": streets,
        "Satelitte": sattelite
    };
    
    var legend = L.control({position: 'bottomleft'});

    

    initializeMap();


    var variable_name = "IRFroutedRunoff";
    var year = 1995;
    var day = 0;
    var day_addition = 1;
    var list_json_files = [];

    drawMap(variable_name, year, day);
    
    var websocket = new WebSocket("ws://127.0.0.1:6789/");
    websocket.onmessage = function (event) {
        d = JSON.parse(event.data);
        var output_div = document.querySelector('#output_' + d.return_div);

        //console.log(d);
        if(d.output){

            outputs = d.output.trim().replaceAll('\n','').split(';##;');
            if (outputs.length > 1){
                charts = JSON.parse(outputs[1].replaceAll("\'", "\""));

                for(var index=0; index<charts.length; index++)
                {
                    chart_name = sessionStorage.getItem("chart_name");
                    if(charts[index].to.includes(chart_name)){

                        if(charts[index].hasOwnProperty('colorlist')){
                            sessionStorage.removeItem("colorlist");
                            color_list = [];
                            colors = charts[index].colorlist.split(',');
                            for(var i=0; i< colors.length; i++)
                            {
                                color_list.push(colors[i]);
                            }

                            sessionStorage.setItem("colorlist", color_list);
                        }
                        if(charts[index].hasOwnProperty('geojson')){
                            geojsons = sessionStorage.getItem("geojson").split(',');
                            jsons = charts[index].geojson.split(',');
                            for(var i=0; i< jsons.length; i++)
                            {
                                if(!geojsons.includes(jsons[i]))
                                    geojsons.push(jsons[i]);
                            }
                            var geojson_str = "";
                            for(var j=0; j< geojsons.length; j++)
                            {
                                if(j != 0)
                                    geojson_str += ",";
                                geojson_str += geojsons[j];
                            }
                            
                            sessionStorage.removeItem("geojson");
                            sessionStorage.setItem("geojson", geojson_str);
                        }
                        if(charts[index].hasOwnProperty('draw') && charts[index].draw == 1){
                            drawMap(variable_name, year, day);
                        }

                    }
                }

            }
            
        }
        
        //drawMap(data.json_file, data.color_list);
    };    

    function drawMap(variable_name, year, day){
        color_list = sessionStorage.getItem("colorlist").split(',');
        json_list_str = sessionStorage.getItem("geojson");
        //json_list_str = "jeoJSON_saskatchewan.json";
        //json_list_str = "jeoJSON_saskatchewan_alberta.json";
        //json_list_str = "jeoJSON_saskatoon.json";
        //json_list_str = "jeoJSON_saskatchewan_alberta_acc_gt_15.json"
        //json_list_str = "jeoJSON_west.json";
        json_list_str = "jeoJSON_west_all.json";
        
        minVal = 1000000;
        maxVal = -1000000;

        loadingModal.show();
        
        if(json_list_str != "")
        {

            json_list_temp = json_list_str.split(',');
            json_list = [];
            
            for (var k=0; k<json_list_temp.length; k++){
                if(json_list_temp[k] == "" || json_list_temp[k] == undefined)
                    continue;
                else
                    json_list.push(json_list_temp[k]);
            }

            if(json_list.length > 0){

                var actions = [];
                json_list.forEach(function(fName){
                    var temp = d3.json(fName);
                    actions.push(temp);
                });

                Promise.all(actions)
                .then(function(files) {

                        total_shape_file = 0;
                        loaded_shape_files = 0;
                        geoJsonData = null;
                        files.forEach(function(file, index){
                            if(index == 0) 
                                geoJsonData=file;
                            else
                                geoJsonData.features = geoJsonData.features.concat(file.features);
                        });

                        console.log(geoJsonData);

                        //var actions_read_var_json = [];
                        var temp_obj = {};
                        
                        
                        geoJsonData.features.forEach(function(data){
                            var temp = d3.json("Data\\IRFroutedRunoff\\Daily\\" + data.properties.seg_id + ".json");
                            list_json_files.push(temp);
                        });
                        total_shape_file = list_json_files.length;                   

                        //console.log(IRFroutedRunoff_data);
                        //console.log(IRFroutedRunoff_data.length);

                        read_variable_jsons();
                        
                        /*
                        Promise.allSettled(list_json_files).then(function(files) {
                            //console.log(files);   
                            var temp = {};
                            files.forEach(function(file, index){
                                //console.log(file.segment_id);      
                                if(file.status == 'fulfilled')                          
                                    temp[file.value.segment_id] = file.value.data;
                                else
                                    console.log(file.status);                                
                            });
                            IRFroutedRunoff_data = temp;

                            console.log(IRFroutedRunoff_data);
                            var seg_ids = Object.keys(IRFroutedRunoff_data);

                            
                            for(var i=0; i<seg_ids.length; i++)
                            {
                                var temp_data = IRFroutedRunoff_data[seg_ids[i]];
                                var years = Object.keys(temp_data);
                                for(var j=0; j<years.length; j++){
                                    var days_data = temp_data[years[j]];
                                    var days = Object.keys(days_data);
                                    for( var k=0; k<days.length; k++){
                                        
                                        var temp_val = days_data[days[k]];
                                        if(temp_val < minVal)
                                            minVal = temp_val;
                                        
                                        if(temp_val > maxVal)
                                            maxVal = temp_val;
                                    }
                                }
                            }

                            console.log(minVal);
                            console.log(maxVal);

                            //setScaleGradesLinear(minVal, maxVal, color_list.length);
                            //setScaleGradesLogarithmic(minVal, maxVal, 1, 61457, color_list.length);
                            setScaleGradesLogarithmic(minVal, maxVal, 1, maxVal*2/3, color_list.length);

                            //console.log(custom_grades);

                            
                            //for(var j=0; j< color_list.length; j++){
                            //    layers.push(L.layerGroup());
                            //}
                            
                            
                            drawShapes();

                        });
                        
                        */
                        

                    }).catch(function(err) {
                        console.log(err);
                        // handle error here
                    });
                                
            }

            /*
            if(json_list.length > 0){

                var counter = 1;
                for (var i=0; i<json_list.length; i++)
                {
                    json_path = json_list[i];
                    fetch(json_path)
                    .then(function(response){
                        return response.json();
                    })
                    .then(function(data){
                        //minVal_t = d3.min(data.features, d=> d.properties.flow_acc);
                        //maxVal_t = d3.max(data.features, d=> d.properties.flow_acc);

                        all_values = [];
                        data.features.forEach(function(d){
                            attr_names = Object.keys(d.properties[variable_name]);
                            for(var it=0; it<attr_names.length; it++)
                            {
                                temp_array = d.properties[variable_name][attr_names[it]];
                                all_values = all_values.concat(temp_array);
                            }
                        });

                        minVal_t = d3.min(all_values);
                        maxVal_t = d3.max(all_values);

                        if(minVal_t < minVal)
                            minVal = minVal_t;
                        
                        if(maxVal_t > maxVal)
                            maxVal = maxVal_t;
                        
                        data_list.push(data);

                        if(counter == json_list.length){
                            layers = [];
                            //console.log("Min : " + minVal);
                            //console.log("Max : " + maxVal);
                            temp_array = [];
                            for(it=0; it<color_list.length; it++)
                                temp_array.push(it);
                            
                                //quantizeScale.domain([minVal, maxVal]).range(temp_array);

                            //setScaleGradesLinear(minVal, maxVal, color_list.length);
                            //setScaleGradesLogarithmic(minVal, maxVal, 1, 61457, color_list.length);
                            setScaleGradesLogarithmic(minVal, maxVal, 1, maxVal*2/3, color_list.length);

                            //console.log(custom_grades);

                            for(var j=0; j< color_list.length; j++){
                                layers.push(L.layerGroup());
                            }
                            
                            drawShapes(data_list);
                        }
                        counter ++;
                    });
                }
                
            }
            */

        }
                
    };

    function updateChart(variable_name, year, day){
        
        //console.log(geoJsonFeature);

        geoJsonFeature.eachLayer(function (layer) { 
            //cus_color = color_list[getIndexOfGrades(layer.feature.properties[variable_name][year][day])]; 
            var seg_id = layer.feature.properties.seg_id;
            if (IRFroutedRunoff_data[seg_id] != undefined){
                cus_color = color_list[getIndexOfGrades(IRFroutedRunoff_data[seg_id][year][day])];
                layer.setStyle({color : cus_color});

            }
            
        });
        
        var theDate = new Date(year, 0, 1);
        var myNewDate = new Date(theDate);
        theDate.setDate(theDate.getDate() + day);

        $('#infoAnimation').html((day+1) + "/365 day of " + year + " (" + theDate.toDateString() + ")");

        //initializeMap();
        //drawMap(variable_name, year, day);
    }

    function setScaleGradesLinear(min, max, no_steps){
        var steps_len = (maxVal-minVal)/no_steps;
        custom_grades = [];
        var prev_val = minVal;
        for(var i=0; i<no_steps-1; i++)
        {
            var val = Math.round(prev_val + steps_len);
            custom_grades.push(val);
            prev_val = val;
        }
    }

    function setScaleGradesLogarithmic(val_min, val_max, log_min, log_max, no_steps){
        custom_grades = [];
        var steps_len = (parseInt(log_max - log_min) / no_steps);

        /*
        for (var i = log_min; i < log_max; i = i + steps_len) {
            var d = val_max - parseInt((Math.log(i) - Math.log(log_min)) / (Math.log(log_max) - Math.log(log_min)) * (val_max - val_min));
            custom_grades.push(d);
        }
        */
        for (var i = 0; i < no_steps; i++) {
            var d = val_max - parseInt((Math.log(log_min+ i*steps_len) - Math.log(log_min)) / (Math.log(log_max) - Math.log(log_min)) * (val_max - val_min));
            custom_grades.push(d.toFixed(2));
        }
        custom_grades = custom_grades.reverse();
        custom_grades.pop();
    }

    function getIndexOfGrades(val){
        for(var i=0; i<custom_grades.length; i++)
        {
            if(val <= custom_grades[i])
                return i;
        }
        return i;
    }

    var printer;

    function drawShapes(){

        this.geoJsonFeature = L.geoJSON(geoJsonData, {
                filter: function(feature){
                    //if (feature.properties.islake == 0) return true;
                    return true;
                },
                style: function (feature) {
                    var seg_id = feature.properties.seg_id;
                    if (IRFroutedRunoff_data[seg_id] == undefined)
                        return {color: 'grey'};
                    cus_color = color_list[getIndexOfGrades(IRFroutedRunoff_data[seg_id][year][day])];
                    return {color: cus_color};
                },
                /*
                onEachFeature: function(feature, layer){
                    //console.log(index);
                    var seg_id = feature.properties.seg_id;
                    if (IRFroutedRunoff_data[seg_id] != undefined)
                        layers[getIndexOfGrades(IRFroutedRunoff_data[seg_id][year][day])].addLayer(layer);
                    //index++;
                }
                */
            }).bindPopup(function (d) {

                return "<div><button onclick='showMetaDataInfo("+ d.feature.properties.seg_id + ")'>Show IRFroutedRunoff</button></div>";
                //return variable_name + ": " + d.feature.properties[variable_name][year][day];
        }).addTo(map);
        
        legend_text = [];                
        for(var j=0; j<=custom_grades.length; j++)
        {
            str_label = "";
            if(j==0)
                str_label += "<= " + custom_grades[j];
            else if(j==custom_grades.length)
                str_label += ">= " + custom_grades[j-1];                                   
            else
                str_label += (custom_grades[j-1]+1) + " - " + custom_grades[j];
            
            legend_text.push(str_label);
        }

        /*
        for(var j=0; j<legend_text.length; j++)
        {
            overlayMaps[legend_text[j]] = layers[j];
            layers[j].addTo(map);
        }
        */

        legend.onAdd = function(m){
            var div = L.DomUtil.create('div', 'info legend');
            div.innerHTML += "<p> River Discharge (m3/sec) </p>"
            for(var i=0; i<color_list.length; i++)
            {
                div.innerHTML += '<div style="margin-bottom: 2px;"><i style="background:' + color_list[i] + '; opacity:1"></i>' + legend_text[i] + '</div>';
            }
            return div;
        }
        legend.addTo(map);
        
        //$('.leaflet-control-layers').remove();
        //L.control.layers(baseLayers, overlayMaps).addTo(map);

        var theDate = new Date(year, 0, 1);
        var myNewDate = new Date(theDate);
        theDate.setDate(theDate.getDate() + day);

        $('#infoAnimation').html((day+1) + "/365 day of " + year + " (" + theDate.toDateString() + ")");
    };

    /*
    function drawShapes(data_list){
        counter_1 = 1;

        for (var i=0; i<data_list.length; i++)
        {
            this.geoJsonFeature = L.geoJSON(data_list[i], {
                filter: function(feature){
                    if (feature.properties.islake == 0) return true;
                },
                style: function (feature) {
                    cus_color = color_list[getIndexOfGrades(feature.properties[variable_name][year][day])];
                    return {color: cus_color};
                },
                onEachFeature: function(feature, layer){
                    //console.log(index);
                    layers[getIndexOfGrades(feature.properties[variable_name][year][day])].addLayer(layer);
                    //index++;
                }
            }).bindPopup(function (d) {

                return "<div><button onclick='showMetaDataInfo("+ d.feature.properties.seg_id + ")'>Show IRFroutedRunoff</button></div>";
                //return variable_name + ": " + d.feature.properties[variable_name][year][day];
            }).addTo(map);


            if(counter_1 == data_list.length){ 

                //console.log(minVal);
                //console.log(maxVal);
                legend_text = [];

                
                for(var j=0; j<=custom_grades.length; j++)
                {
                    str_label = "";
                    if(j==0)
                        str_label += "<= " + custom_grades[j];
                    else if(j==custom_grades.length)
                        str_label += ">= " + custom_grades[j-1];                                   
                    else
                        str_label += (custom_grades[j-1]+1) + " - " + custom_grades[j];
                    
                    legend_text.push(str_label);
                }

                for(var j=0; j<legend_text.length; j++)
                {
                    overlayMaps[legend_text[j]] = layers[j];
                    layers[j].addTo(map);
                }

                legend.onAdd = function(m){
                    var div = L.DomUtil.create('div', 'info legend');
                    div.innerHTML += "<p>" + variable_name + "</p>"
                    for(var i=0; i<color_list.length; i++)
                    {
                        div.innerHTML += '<div style="margin-bottom: 2px;"><i style="background:' + color_list[i] + '; opacity:1"></i>' + legend_text[i] + '</div>';
                    }
                    return div;
                }
                legend.addTo(map);
                
                $('.leaflet-control-layers').remove();
                L.control.layers(baseLayers, overlayMaps).addTo(map);

                var theDate = new Date(year, 0, 1);
                var myNewDate = new Date(theDate);
                theDate.setDate(theDate.getDate() + day);

                $('#infoAnimation').html((day+1) + "/365 day of " + year + " (" + theDate.toDateString() + ")");

            }
            counter_1++;
        }
    };
    */

    function initializeMap(){
        if (this.map != undefined) this.map.remove();        
        this.map = L.map('mapid', {
            //center: [52.123582, -106.66214],
            center: [62.8551, -124.5850],
            zoom: 5,
            layers: [grayscale]
            //layers: [grayscale, cities]
        });
        L.control.layers(baseLayers).addTo(this.map);
        //L.control.layers(baseLayers, overlayMaps).addTo(this.map);

        var animation_control = L.control({position: 'bottomright'});
        animation_control.onAdd = function(m){
            var div = L.DomUtil.create('div', 'info animation');
            var str = ""
            str += "<h4>Animation Panel</h4>";
            str += "<p>Date : <span id='infoAnimation'></span></p>";
            str += "<p>Jump to : ";
            str += "<select id='jumpToDay' style='margin-right:2px'>";
            for(var i=1; i<=31; i++)
                str += "<option value=" + i + ">" + i + "</option>"
            str += "</select>";

            str += "<select id='jumpToMonth' style='margin-right:2px'>";
            str += "<option value='0'>Jan</option>";
            str += "<option value='1'>Feb</option>";
            str += "<option value='2'>Mar</option>";
            str += "<option value='3'>Apr</option>";
            str += "<option value='4'>May</option>";
            str += "<option value='5'>Jun</option>";

            str += "<option value='6'>Jul</option>";
            str += "<option value='7'>Aug</option>";
            str += "<option value='8'>Sep</option>";
            str += "<option value='9'>Oct</option>";
            str += "<option value='10'>Nov</option>";
            str += "<option value='11'>Dec</option>";
            str += "</select>";

            str += "<select id='jumpToYear' style='margin-right:2px'>";
            for(var i=1995; i<=2005; i++)
                str += "<option value=" + i + ">" + i + "</option>"
            str += "</select>";

            str += "<button id='jumpToButton' onclick='jumpToTheDay()'><i class='fa fa-play' aria-hidden='true'></i>  Go</button>";
            str += "</p>";
            str += "<p>Animation Step : 1 <select id='stepAnimation'>";
            str += "<option value='day'> Day </option>";
            str += "<option value='month'> Month </option>";
            str += "<option value='year'> Year </option>";
            str += "</select>  day</p>";
            str += "<button id='playAnimation' onclick='animationNextStep()' style='margin-right: 2px;'><i class='fa fa-play' aria-hidden='true'></i>  Play</button>";
            str += "<button id='pauseAnimation' onclick='pauseAnimation()' style='margin-right: 2px;'><i class='fa fa-pause' aria-hidden='true'></i>  Pause</button>";
            str += "<button id='stopAnimation' onclick='stopAnimation()' style='margin-right: 2px;'><i class='fa fa-stop' aria-hidden='true'></i>  Stop and Reset</button>";

            div.innerHTML = str;
            return div;
        };
        animation_control.addTo(map);


        this.printer = L.easyPrint({
            title: 'Print Map',
      		tileLayer: grayscale,
      		sizeModes: ['Current', 'A4Landscape', 'A4Portrait'],
      		filename: 'myMap',
      		exportOnly: true,
      		hideControlContainer: false,
            className: 'a3CssClass'
		}).addTo(map);

        sidebar = L.control.sidebar({ container: 'sidebar' })
            .addTo(map);
            //.open('home');

    };

    var anim;

    function animationNextStep(){
        var animation_step = $('#stepAnimation').val();
        this.anim = setTimeout(function(){

            if(animation_step == 'day')
                this.day_addition = 1;
            else if (animation_step == 'year')
                this.day_addition = 365;
            else if (animation_step == 'month')
            {
                var date = new Date(this.year, 0, this.day+1);
                date.setMonth( date.getMonth() + 1 );
                this.day_addition = Math.round(parseFloat(date - new Date(this.year, 0, this.day+1))/24/3600/1000);
            }

            this.day = this.day + this.day_addition;
            if(this.day >= 365)
            {
                this.year++;
                this.day = this.day - 365;
            }
            //drawMap(variable_name, year, day);
            updateChart(variable_name, this.year, this.day);
            animationNextStep();
        }, 1000);
    }

    function stopAnimation(){
        this.day = 0;
        this.year = 1995;
        clearTimeout(this.anim);
        //drawMap(variable_name, year, day);
        updateChart(variable_name, year, day);
    }

    function pauseAnimation(){
        clearTimeout(this.anim);
    }

    function jumpToTheDay(){
        var year_text = $('#jumpToYear').val();
        var month_text = $('#jumpToMonth').val();
        var day_text = $('#jumpToDay').val();

        var date = new Date(year_text, month_text, day_text);
        var days = Math.round(parseFloat(date - new Date(year_text, 0, 1))/24/3600/1000);

        this.year = parseInt(year_text);
        this.day = parseInt(days);
        updateChart(variable_name, year_text, days);
    }

    var file_count = 100;
    var total_shape_file = 0;
    var loaded_shape_files = 0;

    async function read_variable_jsons(){
        
        var temp_jsons = [];
        for(var i=0; i<list_json_files.length; i++)
        {
            if(i<file_count)
                temp_jsons.push(list_json_files[i]);
            else
                break;
        }
        //console.log(temp_jsons);

        await Promise.allSettled(temp_jsons).then(function(files) {
            //console.log(files);   
            var temp = {};
            files.forEach(function(file, index){
                //console.log(file.segment_id);      
                if(file.status == 'fulfilled')                          
                    temp[file.value.segment_id] = file.value.data;
                else
                    console.log(file.status);                                
            });
            
            for (var attrname in temp) { IRFroutedRunoff_data[attrname] = temp[attrname]; }
            

            //IRFroutedRunoff_data = IRFroutedRunoff_data.concat(temp);            
            var seg_ids = Object.keys(temp);
            loaded_shape_files += seg_ids.length;
            //console.log(seg_ids.length);
            var percentage_val = parseInt(loaded_shape_files/total_shape_file * 100);

            $('#shapeLoadedFileCount').html(loaded_shape_files);
            $('#shapeTotalFileCount').html(total_shape_file);

            $('#loadingProgress').width(percentage_val+'%');
            $('#loadingProgress').attr('aria-valuenow', percentage_val);
            
            for(var i=0; i<seg_ids.length; i++)
            {
                var temp_data = IRFroutedRunoff_data[seg_ids[i]];
                var years = Object.keys(temp_data);
                for(var j=0; j<years.length; j++){
                    var days_data = temp_data[years[j]];
                    var days = Object.keys(days_data);
                    for( var k=0; k<days.length; k++){
                        
                        var temp_val = days_data[days[k]];
                        if(temp_val < minVal)
                            minVal = temp_val;
                        
                        if(temp_val > maxVal)
                            maxVal = temp_val;
                    }
                }
            }

            if(list_json_files.length < file_count)
            {               
                //console.log(IRFroutedRunoff_data);
                console.log(minVal);
                console.log(maxVal);
                console.log(Object.keys(IRFroutedRunoff_data).length);

                loadingModal.hide();

                //setScaleGradesLinear(minVal, maxVal, color_list.length);
                //setScaleGradesLogarithmic(minVal, maxVal, 1, 61457, color_list.length);
                setScaleGradesLogarithmic(minVal, maxVal, 1, maxVal*2/3, color_list.length);

                //console.log(custom_grades);

                
                //for(var j=0; j< color_list.length; j++){
                //    layers.push(L.layerGroup());
                //}
                
                
                drawShapes();

                return;
            }
                

            list_json_files.splice(0, file_count);
            read_variable_jsons();
            
            
            //console.log("After Recursion");
            //console.log(IRFroutedRunoff_data);

            //if()
            //console.log(minVal);
            //console.log(maxVal);

        });
                
    }

    /*
    function manualPrint () {
		this.printer.printMap('CurrentSize', 'MyManualPrint')
	}
    */

    //drawHistoryHeatMapChart(seg_id, div_name, data);

</script>



</body>
</html>