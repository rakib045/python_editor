<!DOCTYPE html>
<html>
    <head>
        <title>Python Command</title>
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.4.0/font/bootstrap-icons.css">
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-BmbxuPwQa2lc/FVzBcNJ7UAyJxM6wuqIj61tLrc4wSX0szH/Ev+nYRRuWlolflfl" crossorigin="anonymous">
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta2/dist/js/bootstrap.bundle.min.js" integrity="sha384-b5kHyXgcpbZJO/tY9Ul7kGkf1S0CWuKcCD38l8YkeH8z8QjE0GmW1gYU5S9FOnJ0" crossorigin="anonymous"></script>
    
    </head>
    <body>
        
        <div class="container">
            <h1>Advanced VIS</h1>
            <div>
                <button type="button" class="btn btn-outline-success" id="run_all">
                    <i class="bi bi-play-fill"></i> Run Everything</button>
                <button type="button" class="btn btn-outline-success" id="run_code"><i class="bi bi-arrow-down-right"></i> Run Code</button>
                <button type="button" class="btn btn-outline-success" id="run_chart"><i class="bi bi-graph-up"></i> Run Chart</button>
                <!--
                <button type="button" class="btn btn-outline-info" id="run_all"><i class="bi bi-caret-right-fill"></i>Add to Chart</button> 
                <button type="button" class="btn btn-outline-danger" id="run_all"><i class="bi bi-caret-right-fill"></i> Clear Console</button>
                <button type="button" class="btn btn-outline-danger" id="run_all"><i class="bi bi-caret-right-fill"></i> Clear Charts</button>
                -->
            </div>


            <div class="row">
              <div class="col-sm">
                
                <div class="mb-3">
                    <label for="exampleFormControlTextarea1" class="form-label">Write your code here:</label>
                    <textarea id="input_code" class="form-control" rows="30" style="font-size: 14px;">
%%%% #Markup# %%%%
# Your mark-up code goes here

%%%% #Code# %%%%

%%%% #Chart# %%%%
# Add your generated charts here                                                                                         
  
                    </textarea>
                </div>

              </div>

              <div class="col-sm">
                <div class="mb-3">
                    <div>
                        <span id="connection_info" class="badge bg-warning text-dark">Connecting ...</span>
                        <span id="status_info" class=""></span>
                    </div>
                    <div class="card border-success" style="margin-top:10px; font-size:0.8em">
                        <div class="card-header bg-transparent border-success text-success">
                            <h5 class="card-title">Charts</h5>
                        </div>
                        <div class="card-body text-success" style="min-height: 350px;">
                          <div class="card-text">
                            <ul class="nav nav-tabs" id="chartTab" role="tablist">
                            </ul>
                            <div class="tab-content" id="chartTabContent">
                            </div>
                          </div>
                        </div>                        
                    </div>

                    <label for="exampleFormControlTextarea1" class="form-label">Console output: </label>
                    
                    
                    <textarea id="output_console" disabled class="form-control" rows="10" style="font-size:12px"></textarea> 
                                       
                </div>
              </div>
            </div>
          </div>

        <script>
            var websocket = new WebSocket("ws://127.0.0.1:6789/");
            var input_code = document.querySelector('#input_code');
            var connection_info = document.querySelector('#connection_info');
            var status_info = document.querySelector('#status_info');
            var output_console = document.querySelector('#output_console');

            var chartTab = document.querySelector('#chartTab');
            var chartTabContent = document.querySelector('#chartTabContent');

            var run_all = document.querySelector('#run_all');
            var run_code = document.querySelector('#run_code');
            var run_chart = document.querySelector('#run_chart');


           /*
            input_code.value = "%%%% #Markup# %%%%\n";
            input_code.value += "# Your mark-up code goes here\n\n";
            input_code.value += "%%%% #Code# %%%%\n";
            input_code.value += "# Your python code goes here\n\n";
            input_code.value += "%%%% #Chart# %%%%\n";
            input_code.value += "# Add your generated charts here\n";
            */

            run_all.onclick = function (event) {
                var d = new Date();
                output_console.value += "-----------------------------------------";
                output_console.value += "-----------------------------------------\n";
                output_console.value += d + '\n';

                status_info.setAttribute("class", "badge bg-warning text-dark");
                status_info.innerHTML = "Running ...";

                var total_code_array = input_code.value.split('%%%%');

                var sending_data = {};

                for(var i=0; i< total_code_array.length; i++)
                {
                    if(total_code_array[i].includes('#Markup#'))
                        sending_data['markup'] = total_code_array[i+1];
                    else if(total_code_array[i].includes('#Code#'))
                        sending_data['code'] = total_code_array[i+1];
                    else if(total_code_array[i].includes('#Chart#')){
                        sending_data['chart'] = total_code_array[i+1];
                    }                        
                    
                }

                websocket.send(JSON.stringify(sending_data));
            }

            run_code.onclick = function (event) {
                var d = new Date();
                output_console.value += "-----------------------------------------";
                output_console.value += "-----------------------------------------\n";
                output_console.value += d + '\n';

                status_info.setAttribute("class", "badge bg-warning text-dark");
                status_info.innerHTML = "Running ...";

                var total_code_array = input_code.value.split('%%%%');

                var sending_data = {};

                for(var i=0; i< total_code_array.length; i++)
                {
                    if(total_code_array[i].includes('#Code#'))
                        sending_data['code'] = total_code_array[i+1];                    
                }

                websocket.send(JSON.stringify(sending_data));
            }

            run_chart.onclick = function (event) {
                var d = new Date();
                output_console.value += "-----------------------------------------";
                output_console.value += "-----------------------------------------\n";
                output_console.value += d + '\n';

                status_info.setAttribute("class", "badge bg-warning text-dark");
                status_info.innerHTML = "Running ...";

                var total_code_array = input_code.value.split('%%%%');

                var sending_data = {};

                for(var i=0; i< total_code_array.length; i++)
                {
                    if(total_code_array[i].includes('#Chart#'))
                        sending_data['chart'] = total_code_array[i+1];                    
                }

                websocket.send(JSON.stringify(sending_data));
            }

            websocket.onmessage = function (event) {
                //console.log(event);
                d = JSON.parse(event.data);
                

                if(d.error){
                    status_info.setAttribute("class", "badge bg-danger");
                    status_info.innerHTML = "Error in code";
                    output_console.value += d.error;
                }
                if(d.output){
                    status_info.setAttribute("class", "badge bg-success");
                    status_info.innerHTML = "Code executed";
                    output_console.value += d.output;
                }
                if(d.chart != ''){ 
                    d.chart = JSON.parse(d.chart.replaceAll("\'", "\""));                   
                    status_info.setAttribute("class", "badge bg-success");
                    status_info.innerHTML = "Code executed";
                    output_console.value += "Chart has been updated\n";

                    str_html = "";
                    str1_html = "";

                    for(var i=0; i<d.chart.length; i++)
                    {
                        if(d.chart[i].to.includes('master'))
                        {
                            fname = d.chart[i].name.replaceAll(' ','')
                            order = d.chart[i].order

                            str_html += "<li class='nav-item' role='presentation'>";
                            if(i==0)
                                str_html += "<button class='nav-link active'";
                            else
                                str_html += "<button class='nav-link'";

                            str_html += " id='" + fname + "_tab";
                            str_html += "' data-bs-toggle='tab' data-bs-target='#" + fname + "' type='button' role='tab'";
                            str_html += "aria-controls='"+ fname +"' aria-selected='true'>"+ d.chart[i].name +"</button>";
                            str_html += "</li>";
                        
                            str1_html += "<div class='tab-pane fade show";
                            if(i==0)
                                str1_html += " active";
                            str1_html += "' id='"+ fname +"' role='tabpanel' aria-labelledby='" + fname + "_tab" +"'>";
                            if (d.chart[i].type == "image")
                                str1_html += "<img src='" + d.chart[i].path + "' />";
                            else if (d.chart[i].type == "iframe"){
                                str1_html += "<a href='" + d.chart[i].path + "' target='_blank'>Open in new tab</a>";
                                str1_html += "<iframe src='" + d.chart[i].path + "' width='600px' height='400px'></iframe>";                            
                            }
                                
                            str1_html += "</div>";
                        }
                                                
                    }

                    if(str_html != '' && str1_html != '')
                    {
                        chartTab.innerHTML = str_html;
                        chartTabContent.innerHTML = str1_html;
                    }
                    
                    
                }
                if(!d.error && !d.code && !d.chart)
                {
                    status_info.setAttribute("class", "badge bg-success");
                    status_info.innerHTML = "Code executed";
                    output_console.value += "Code executed succesfully\n";
                }
                /*
                else{
                    status_info.setAttribute("class", "badge bg-success");
                    status_info.innerHTML = "Code executed";
                    output_console.value += "Code execution finishes without console output.\n"
                }
                */
            };
            websocket.onopen = function (event) {
                output_console.value = "Version: ";
                connection_info.setAttribute("class", "badge bg-success");
                connection_info.innerHTML = "Connected";
            };
            websocket.onerror = function (event) {
                connection_info.setAttribute("class", "badge bg-danger");
                connection_info.innerHTML = "Connection Error";
            };
        </script>
    </body>
</html>