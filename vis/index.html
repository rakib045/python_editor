<!DOCTYPE html>
<html>
    <head>
        <title>Python Command</title>
        <script
  src="https://code.jquery.com/jquery-3.6.0.min.js"
  integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4="
  crossorigin="anonymous"></script>
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.4.0/font/bootstrap-icons.css">
        
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-BmbxuPwQa2lc/FVzBcNJ7UAyJxM6wuqIj61tLrc4wSX0szH/Ev+nYRRuWlolflfl" crossorigin="anonymous">
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta2/dist/js/bootstrap.bundle.min.js" integrity="sha384-b5kHyXgcpbZJO/tY9Ul7kGkf1S0CWuKcCD38l8YkeH8z8QjE0GmW1gYU5S9FOnJ0" crossorigin="anonymous"></script>
        

        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/jstree/3.2.1/themes/default/style.min.css" />
        <script src="https://cdnjs.cloudflare.com/ajax/libs/jstree/3.2.1/jstree.min.js"></script>

        <style>
            .accrd-button{
                margin-right: 5px;
                font-size: 0.8em;
            }
        </style>
    </head>
    <body>
        
        <div class="container" style="max-width: 100%;">
            <h1>Advanced VIS</h1>
            <div style="padding-bottom: 10px;">
                <a href="/out/" class="btn btn-outline-success" id="documentation" target="_blank" >
                    <i class="bi bi-info-square-fill"></i> Documentation</a>

                    <a href="#" onclick="save_in_text()" class="btn btn-outline-success" id="save_code" >
                        <i class="bi bi-info-square-fill"></i> Save Code</a>

                    <button type="button" class="btn btn-outline-success" data-toggle="modal" data-target="#uploadModal" id="uploadModalButton">
                        <i class="bi bi-upload"></i> Upload Code
                    </button>

                    <div style="float:right">
                        <div style="font-size: 14px;">
                            <i class="bi bi-person-circle" style="color: green;"></i>
                            <span>Log in as Guest_</span><span id="user_id"></span>
                        </div>
                        <div>
                            <span id="connection_info" class="badge bg-warning text-dark">Connecting to Socket Server ...</span>
                            <span id="status_info" class=""></span>
                        </div>
                        
                    </div>

                <!--
                <button type="button" class="btn btn-outline-success" id="run_all" disabled>
                    <i class="bi bi-collection-play"></i> Run Everything</button>
                    -->
            </div>
            <div class="row">
              <div class="col-6">
                <!--<h4>Write your code here:</h4> -->
                <div class="accordion" id="accordionExample" style="padding-bottom: 10px;">
                    <div class="accordion-item" id="A1">
                      <h2 class="accordion-header" id="headingOne">
                        <div class="accordion-button bg-white border-success text-success" style="padding: 10px 15px; border-width: 2px;">
                          <div style="font-size: 24px" class="col-5" type="button" data-bs-toggle="collapse" data-bs-target="#collapseOne" aria-expanded="true" aria-controls="collapseOne">Code</div>
                          <div class="col-6">
                            <button type="button" class="accrd-button btn btn-outline-success" onclick="run_code_section('1')"><i class="bi bi-play-fill"></i> Run</button>
                            <button type="button" class="accrd-button btn btn-outline-warning" onclick="clear_txt('1')"><i class="bi bi-eraser"></i> Clear</button>
                            <button type="button" class="accrd-button btn btn-outline-danger" onclick="remove_section('A1')"><i class="bi bi-trash"></i> Remove</button>
                          </div>
                            
                        </div>
                      </h2>
                      <div style="border-width: 0px 2px 2px 2px;" id="collapseOne" class="accordion-collapse collapse show border-success" aria-labelledby="headingOne" data-bs-parent="#accordionExample1">
                        <div class="accordion-body">
                            <textarea id="input_code_1" class="form-control" rows="25" style="font-size: 14px; margin: 5px 0px;"></textarea>
                            <div id="output_1"></div>                                                     
                        </div>
                      </div>
                    </div>
                </div>

                <!--
                <div class="input-group">
                    <div class="input-group-text btn-success" id="btnGroupAddon">New Section</div>
                    <input type="text" class="form-control border-success text-success" aria-describedby="btnGroupAddon" id="add_section_textbox"/>
                    <button type="button" class="btn btn-outline-success" id="add_section"><i class="bi bi-plus"></i> Add</button>
                </div>
                -->
              </div>

              <div class="col-3">
                
                <div class="card border-success" style="font-size:0.8em">
                    <div class="card-header bg-transparent border-success text-success">
                        <h4 class="card-title">Charts</h4>
                    </div>
                    <div class="card-body text-success" style="min-height: 350px;">
                      <div class="card-text">
                        <ul class="nav nav-tabs" id="chartTab" role="tablist">
                        </ul>
                        <div class="tab-content" id="chartTabContent">
                        </div>
                      </div>
                    </div>                        
                </div>

              </div>

              <div class="col-3">
                
                <div class="card border-success" style="font-size:0.8em">
                    <div class="card-header bg-transparent border-success text-success">
                        <h4 class="card-title">Variables</h4>
                    </div>
                    <div class="card-body text-success">
                      <div class="card-text">
                            <div id="variables_jstree"></div>
                      </div>
                    </div>                        
                </div>

              </div>

                            


            </div>
          </div>


        <!-- Modal -->
        <div class="modal fade" id="uploadModal" tabindex="-1" role="dialog" aria-labelledby="uploadModalLabel" aria-hidden="true">
            <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                <h5 class="modal-title" id="uploadModalLabel">Upload Code</h5>
                </div>
                <div class="modal-body">
                    <ul class="nav nav-tabs" id="chartTab" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="Server_tab" data-bs-toggle="tab" data-bs-target="#Server" type="button" role="tab" aria-controls="Server" aria-selected="true">Server</button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="LocalMachine_tab" data-bs-toggle="tab" data-bs-target="#LocalMachine" type="button" role="tab" aria-controls="LocalMachine" aria-selected="true">Local Machine</button>
                        </li>
                    </ul>

                    <div class="tab-content" id="chartTabContent">
                        <div class="tab-pane fade show active" id="Server" role="tabpanel" aria-labelledby="Server_tab">
                            <div style="padding: 5px; border-left: 1px solid rgb(222, 226, 230); border-bottom: 1px solid rgb(222, 226, 230); border-right: 1px solid rgb(222, 226, 230);">
                                <div class="mb-3">
                                    <label for="formFile" class="form-label">Select File : </label>
                                    <!--
                                    <select class="form-select" size="6" aria-label="size select example">
                                        <option value="1">One</option>
                                        <option value="2">Two</option>
                                        <option value="3">Three</option>
                                        <option value="4">Four</option>
                                        <option value="5">Five</option>
                                        <option value="6">Six</option>
                                      </select>
                                    -->
                                    <div id="file_server_browse_jstree"></div>
                                </div>
                                
                            </div>                            

                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-dismiss="modal" id="uploadModalCloseButtonTab1">Close</button>
                                <button type="button" class="btn btn-primary"  id="loadFromServerModalButton">Load</button>
                            </div>
                        </div>
                        <div class="tab-pane fade show" id="LocalMachine" role="tabpanel" aria-labelledby="LocalMachine_tab">
                            <div style="padding: 5px; border-left: 1px solid rgb(222, 226, 230); border-bottom: 1px solid rgb(222, 226, 230); border-right: 1px solid rgb(222, 226, 230);">
                                <div class="mb-3">
                                    <label for="formFile" class="form-label">Select File Type</label>
                                    <select class="form-select" aria-label="Default select example" id="uploadFileType">
                                        <option value="py" selected>Python File (.py)</option>
                                        <option value="txt">Text File (.txt)</option>
                                        <option value="ipynb">Jupyter Notebook File (.ipynb)</option>
                                    </select>
                                </div>
            
                                <div class="mb-3">
                                    <label for="formFile" class="form-label">Browse for the File</label>
                                    <input class="form-control" type="file" id="uploadedFile">
                                </div>
                                <!--
            
                                <div class="mb-3">
                                    <label for="formFile" class="form-label">Code Segment Name</label>
                                    <input class="form-control" type="input" id="codeSegmentName" value="UploadedCode">
                                </div>
                                -->

                                <div class="modal-footer">
                                    <button type="button" class="btn btn-secondary" data-dismiss="modal" id="uploadModalCloseButtonTab2">Close</button>
                                    <button type="button" class="btn btn-primary"  id="loadModalButton">Load</button>
                                </div>
                            </div>
                        </div>
                    </div>
                
                    

                </div>
                <!--
                    <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal" id="uploadModalCloseButton">Close</button>
                    <button type="button" class="btn btn-primary"  id="loadModalButton">Load</button>
                    </div>
                -->
            </div>
            </div>
        </div>

        <script>

            var user_id = '';

            //var web_socket_url = "ws://206.12.95.141/AdvancedVisWebSocket";
            var web_socket_url = "ws://127.0.0.1:6789/";

            var server_upload_code_filepath = '';
            $( document ).ready(function() {
                //console.log( "ready!" );
                //$('#uploadModal').modal();
                $('#file_server_browse_jstree').jstree({ 
                        'core' : {
                        'themes' : { 'stripes' : true },
                        'data' : [
                            { "id" : "RiverFlow", "parent" : "#", "text" : "Sample River Flow", "data" : "" },
                            { "id" : "RiverFlow__bow_river_kwt_routed_runoff", "parent" : "RiverFlow", "text" : "bow_river_kwt_routed_runoff.txt", "icon" : "jstree-file", "data" : "/SampleCode/RiverFlow/bow_river_kwt_routed_runoff.txt" },
                            
                            { "id" : "CatchmentBasin", "parent" : "#", "text" : "Sample Catchment Basin", "data" : "" },
                            { "id" : "CatchmentBasin__bow_river_catchment_ScalarSWE", "parent" : "CatchmentBasin", "text" : "bow_river_catchment_ScalarSWE.txt", "icon" : "jstree-file", "data" : "/SampleCode/CatchmentBasin/bow_river_catchment_ScalarSWE.txt" },

                            { "id" : "RiverFlowCatchmentBasin", "parent" : "#", "text" : "Sample River Flow and Catchment Basin", "data" : "" },
                            { "id" : "RiverFlowCatchmentBasin__bow_rvr_kwt_routed_runoff_and_swe", "parent" : "RiverFlowCatchmentBasin", "text" : "bow_rvr_kwt_routed_runoff_and_swe.txt", "icon" : "jstree-file", "data" : "/SampleCode/RiverFlowCatchmentBasin/bow_rvr_kwt_routed_runoff_and_swe.txt" }
                        ]
                    } 
                });

                $('#variables_jstree').jstree({  
                        'core' : {
                        'themes' : { 'stripes' : true },
                        'data' : [
                            { "id" : "RiverFlow", "parent" : "#", "text" : "River Flow", "data" : "" },

                            { "id" : "RiverFlow__dlayRunoff", "parent" : "RiverFlow", "text" : "dlayRunoff", "icon" : "jstree-file", "data" : "" },
                            { "id" : "RiverFlow__IRFroutedRunoff", "parent" : "RiverFlow", "text" : "IRFroutedRunoff", "icon" : "jstree-file", "data" : "" },
                            { "id" : "RiverFlow__KWTroutedRunoff", "parent" : "RiverFlow", "text" : "KWTroutedRunoff", "icon" : "jstree-file", "data" : "" },
                            { "id" : "RiverFlow__sumUpstreamRunoff", "parent" : "RiverFlow", "text" : "sumUpstreamRunoff", "icon" : "jstree-file", "data" : "" },
                            
                            { "id" : "CatchmentBasin", "parent" : "#", "text" : "Catchment Basin", "data" : "" },
                            { "id" : "CatchmentBasin__scalarAquiferBaseflow", "parent" : "CatchmentBasin", "text" : "scalarAquiferBaseflow", "icon" : "jstree-file", "data" : "" },
                            { "id" : "CatchmentBasin__scalarAquiferStorage", "parent" : "CatchmentBasin", "text" : "scalarAquiferStorage", "icon" : "jstree-file", "data" : "" },
                            { "id" : "CatchmentBasin__scalarCanopyWat", "parent" : "CatchmentBasin", "text" : "scalarCanopyWat", "icon" : "jstree-file", "data" : "" },
                            { "id" : "CatchmentBasin__scalarInfiltration", "parent" : "CatchmentBasin", "text" : "scalarInfiltration", "icon" : "jstree-file", "data" : "" },
                            { "id" : "CatchmentBasin__scalarLatHeatTotal", "parent" : "CatchmentBasin", "text" : "scalarLatHeatTotal", "icon" : "jstree-file", "data" : "" },
                            { "id" : "CatchmentBasin__scalarNetRadiation", "parent" : "CatchmentBasin", "text" : "scalarNetRadiation", "icon" : "jstree-file", "data" : "" },
                            { "id" : "CatchmentBasin__scalarRainPlusMelt", "parent" : "CatchmentBasin", "text" : "scalarRainPlusMelt", "icon" : "jstree-file", "data" : "" },
                            { "id" : "CatchmentBasin__scalarSenHeatTotal", "parent" : "CatchmentBasin", "text" : "scalarSenHeatTotal", "icon" : "jstree-file", "data" : "" },
                            { "id" : "CatchmentBasin__scalarSoilBaseflow", "parent" : "CatchmentBasin", "text" : "scalarSoilBaseflow", "icon" : "jstree-file", "data" : "" },
                            { "id" : "CatchmentBasin__scalarSoilDrainage", "parent" : "CatchmentBasin", "text" : "scalarSoilDrainage", "icon" : "jstree-file", "data" : "" },
                            { "id" : "CatchmentBasin__scalarSurfaceRunoff", "parent" : "CatchmentBasin", "text" : "scalarSurfaceRunoff", "icon" : "jstree-file", "data" : "" },
                            { "id" : "CatchmentBasin__scalarSWE", "parent" : "CatchmentBasin", "text" : "scalarSWE", "icon" : "jstree-file", "data" : "" },
                            { "id" : "CatchmentBasin__scalarTotalET", "parent" : "CatchmentBasin", "text" : "scalarTotalET", "icon" : "jstree-file", "data" : "" },
                            { "id" : "CatchmentBasin__scalarTotalRunoff", "parent" : "CatchmentBasin", "text" : "scalarTotalRunoff", "icon" : "jstree-file", "data" : "" },
                            { "id" : "CatchmentBasin__scalarTotalSoilWat", "parent" : "CatchmentBasin", "text" : "scalarTotalSoilWat", "icon" : "jstree-file", "data" : "" }

                            ]
                        }
                        
                });
            });

            $('#file_server_browse_jstree').on("changed.jstree", function (e, data) {
                //console.log(data.selected);
                //console.log(window.location.href + data.node.data);
                server_upload_code_filepath = data.node.data;
            });

            $('#loadFromServerModalButton').click(function(){
                if(server_upload_code_filepath == '')
                    alert('Selected item is a folder, not a file. Please, select a file.');
                else{
                    //alert(window.location.href + server_upload_code_filepath);
                    $.ajax({
                        url: window.location.href + server_upload_code_filepath,
                        success: function (data){
                            //console.log(data);
                            add_text_in_code_textbox(data);
                            $('#uploadModal').modal('hide');
                        }
                    });
                }
            });

            var upload_modal_button = document.querySelector('#uploadModalButton');

            var upload_modal_close_button_tab1 = document.querySelector('#uploadModalCloseButtonTab1');
            var upload_modal_close_button_tab2 = document.querySelector('#uploadModalCloseButtonTab2');

            var load_modal_button = document.querySelector('#loadModalButton');

            var upload_file_type_dd = document.querySelector('#uploadFileType');
            var code_segment_name_textbox = document.querySelector('#codeSegmentName');


            upload_modal_button.onclick = function (event) {
                $('#uploadModal').modal('show');
            }
            upload_modal_close_button_tab1.onclick = function (event) {
                $('#uploadModal').modal('hide');
            }
            upload_modal_close_button_tab2.onclick = function (event) {
                $('#uploadModal').modal('hide');
            }
            load_modal_button.onclick = function (event) {
                if(upload_file_type_dd.value == 'py')
                    loadFileAsText('uploadedFile');
                else if(upload_file_type_dd.value == 'ipynb')
                    loadFileAsJupyterNotebook('uploadedFile');
                else
                    loadFileAsText('uploadedFile');
                $('#uploadModal').modal('hide');
            }
            

            var websocket = new WebSocket(web_socket_url);
            var input_code = document.querySelector('#input_code');
            var connection_info = document.querySelector('#connection_info');
            var status_info = document.querySelector('#status_info');
            //var output_console = document.querySelector('#output_console');

            var chartTab = document.querySelector('#chartTab');
            var chartTabContent = document.querySelector('#chartTabContent');
            
            var add_section = document.querySelector('#add_section');
            var add_section_textbox = document.querySelector('#add_section_textbox');
            var accordionExample = document.querySelector('#accordionExample');


            websocket.onmessage = function (event) {
                //console.log(event);
                d = JSON.parse(event.data);

                if(d['message_type'] == 'connection_establish'){
                    user_id = d.output;
                    $('#user_id').html(user_id);
                }
                else if(d['message_type'] == 'returned_call'){
                    if(d['user_id'] == user_id) {
                        var output_div = document.querySelector('#output_' + d.return_div);
                        //output_div.innerHTML = "";
                        
                        if(d.error){
                            status_info.setAttribute("class", "badge bg-danger");
                            status_info.innerHTML = "Error in code";
                            //output_console.value += d.error;
                            output_div.innerHTML = d.error;
                        }
                        if(d.output){
                            //status_info.setAttribute("class", "badge bg-success");
                            //status_info.innerHTML = "Code executed";

                            outputs = d.output.trim().replaceAll('\n','').split(';##;');
                            if (output_div != undefined)
                                output_div.innerHTML = outputs[0];
                            //output_console.value += outputs[0];

                            if (outputs.length > 1){

                                charts = JSON.parse(outputs[1].replaceAll("\'", "\""));                   
                                status_info.setAttribute("class", "badge bg-success");
                                status_info.innerHTML = "Code executed";
                                //output_console.value += "Chart has been updated\n";

                                str_html = "";
                                str1_html = "";

                                for(var i=0; i<charts.length; i++)
                                {
                                    if(charts[i].to.includes('master'))
                                    {
                                        fname = charts[i].name.replaceAll(' ','')
                                        order = charts[i].order

                                        str_html += "<li class='nav-item' role='presentation'>";
                                        if(i==0)
                                            str_html += "<button class='nav-link active'";
                                        else
                                            str_html += "<button class='nav-link'";

                                        str_html += " id='" + fname + "_tab";
                                        str_html += "' data-bs-toggle='tab' data-bs-target='#" + fname + "' type='button' role='tab'";
                                        str_html += "aria-controls='"+ fname +"' aria-selected='true'>"+ charts[i].name +"</button>";
                                        str_html += "</li>";
                                    
                                        str1_html += "<div class='tab-pane fade show";
                                        if(i==0)
                                            str1_html += " active";
                                        str1_html += "' id='"+ fname +"' role='tabpanel' aria-labelledby='" + fname + "_tab" +"'>";
                                        if (charts[i].type == "image")
                                            str1_html += "<img style='width:100%' src='" + charts[i].path + "' />";
                                        else if (charts[i].type == "iframe"){
                                            str1_html += "<a href='" + charts[i].path + "' target='_blank'>Open in new tab</a>";
                                            str1_html += "<iframe src='" + charts[i].path + "' width='600px' height='400px'></iframe>";                            
                                        }
                                        else if (charts[i].type == "new_tab"){ 
                                            window.open(charts[i].path + '&user_id=' + user_id, '_blank');                    
                                        }
                                            
                                        str1_html += "</div>";
                                    }
                                                            
                                }
                                if(str_html != '' && str1_html != '')
                                {
                                    chartTab.innerHTML = str_html;
                                    chartTabContent.innerHTML = str1_html;

                                    if (output_div != undefined)
                                        output_div.innerHTML += "</br> Chart has been updated!!!";
                                }

                            }
                            
                                                
                        }
                        if(!d.error && !d.code && !d.output)
                        {
                            status_info.setAttribute("class", "badge bg-success");
                            status_info.innerHTML = "Code executed";
                            //output_console.value += "Code executed succesfully\n";
                            if (output_div != undefined)
                                output_div.innerHTML = "Code executed succesfully";
                        }
                        /*
                        else{
                            status_info.setAttribute("class", "badge bg-success");
                            status_info.innerHTML = "Code executed";
                            output_console.value += "Code execution finishes without console output.\n"
                        }
                        */

                    }
                    
                }
                
            };
            websocket.onopen = function (event) {
                //output_console.value = "Version: ";
                connection_info.setAttribute("class", "badge bg-success");
                connection_info.innerHTML = "Connected with Library Server";
            };
            websocket.onerror = function (event) {
                connection_info.setAttribute("class", "badge bg-danger");
                connection_info.innerHTML = "Connection Error with Library Server";
            };

            /*
            add_section.onclick = function (event) {
                
                add_text_in_code_section(add_section_textbox.value, '');
            }
            */

            function add_text_in_code_textbox(code_str){
                $('#input_code_1').val(code_str);
            };

            function add_text_in_code_section(str_name, code_str){

                var random_str = Math.random().toString(36).substring(7);
                section_name = str_name.trim().replace(' ','') + random_str;
                var str = "<div class='accordion-item' id='" + section_name + "'>";
                str +=  "<h2 class='accordion-header' id='heading" + section_name + "'>";
                str +=  "<div class='accordion-button bg-white border-success text-success' style='padding: 10px 15px; border-width: 2px'>";
                str +=  "<div style='font-size: 24px' class='col-5'  type='button' data-bs-toggle='collapse' data-bs-target='#collapse" + section_name + "' aria-expanded='false' aria-controls='collapse"+section_name+"' >";
                str +=  str_name + "</div>";
                str +=  "<div class='col-6'>";
                str +=  "<button type='button' class='accrd-button btn btn-outline-success' onclick='run_code_section(\"" + section_name + "\")'><i class='bi bi-play-fill'></i> Run</button>";
                str +=  "<button type='button' class='accrd-button btn btn-outline-warning' onclick='clear_txt(\"" + section_name + "\")'><i class='bi bi-eraser'></i> Clear</button>";
                str +=  "<button type='button' class='accrd-button btn btn-outline-danger' onclick='remove_section(\"" + section_name + "\")'><i class='bi bi-trash'></i> Remove</button>";                                                      
                str +=  "</div></div></h2>";
                str +=  "<div style='border-width: 0px 2px 2px 2px;' id='collapse" + section_name + "' class='accordion-collapse collapse border-success' aria-labelledby='heading" + section_name + "' data-bs-parent='#accordionExample'>";
                str +=  "<div class='accordion-body'>";
                str +=  "<textarea id='input_code_" + section_name + "' class='form-control' rows='15' style='font-size: 14px;margin: 5px 0px;'>";
                str +=  code_str;
                str +=  "</textarea>";
                str +=  "<div id='output_" + section_name + "'></div>";
                str +=  "</div></div></div>";

                accordionExample.innerHTML += str;

            };

            function clear_txt(str_name){
                var textarea_box = document.querySelector('#input_code_' + str_name);
                textarea_box.value = "";
            };

            function remove_section(str_name){
                var section = document.querySelector('#' + str_name);
                section.remove();
            };

            function run_code_section(str_name){
                //var d = new Date();
                //output_console.value += "-----------------------------------------";
                //output_console.value += "-----------------------------------------\n";
                //output_console.value += d + '\n';

                status_info.setAttribute("class", "badge bg-warning text-dark");
                status_info.innerHTML = "Running ...";

                var textarea_box = document.querySelector('#input_code_' + str_name);

                var sending_data = {};
                sending_data['code'] = textarea_box.value;
                sending_data['return_div'] = str_name;
                sending_data['user_id'] = user_id;

                var output_div = document.querySelector('#output_' + str_name);
                output_div.innerHTML = "Code is running..."

                websocket.send(JSON.stringify(sending_data));
            }


            function loadFileAsText(div_id_name){
                var fileToLoad = document.getElementById(div_id_name).files[0];

                var fileReader = new FileReader();
                fileReader.onload = function(fileLoadedEvent){
                    var textFromFileLoaded = fileLoadedEvent.target.result;
                    add_text_in_code_textbox(textFromFileLoaded);
                    
                    //add_text_in_code_section(code_segment_name_textbox.value, textFromFileLoaded);
                };

                fileReader.readAsText(fileToLoad, "UTF-8");
            }

            function loadFileAsJupyterNotebook(div_id_name){
                var fileToLoad = document.getElementById(div_id_name).files[0];

                var fileReader = new FileReader();
                fileReader.onload = function(fileLoadedEvent){
                    var textFromFileLoaded = fileLoadedEvent.target.result;

                    var str_code = "";
                    var jsonObj = JSON.parse(textFromFileLoaded);

                    for(var i=0; i<jsonObj.cells.length; i++)
                    {
                        if(jsonObj.cells[i].cell_type == 'code')
                        {
                            str_code += JSON.parse(textFromFileLoaded).cells[i].source.join('') + '\n';
                        }
                    }
                    add_text_in_code_textbox(str_code);
                    //add_text_in_code_section(code_segment_name_textbox.value, str_code);
                };

                fileReader.readAsText(fileToLoad, "UTF-8");
            }

            function save_in_text(){
                var text = document.getElementById("input_code_1").value;
                //text = text.replace(/\n/g, "\r\n"); // To retain the Line breaks.
                var blob = new Blob([text], { type: "text/plain"});
                var anchor = document.createElement("a");
                anchor.download = "my_code.txt";
                anchor.href = window.URL.createObjectURL(blob);
                anchor.target ="_blank";
                anchor.style.display = "none"; // just to be safe!
                document.body.appendChild(anchor);
                anchor.click();
                document.body.removeChild(anchor);
            };
        </script>
    </body>
</html>