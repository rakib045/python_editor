<html>
<head>	
	<title>River Flow</title>

	<meta charset="utf-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!--
    <script src="https://code.jquery.com/jquery-3.5.1.min.js" integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0=" crossorigin="anonymous"></script>
        -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" integrity="sha512-xodZBNTC5n17Xt2atTPuE1HxjVMSvLVW9ocqUKLsCC5CXdbqCmblAshOMAS6/keqq/sMZMZ19scR4PsZChSR7A==" crossorigin=""/>
    <link href="http://maxcdn.bootstrapcdn.com/font-awesome/4.1.0/css/font-awesome.min.css" rel="stylesheet">
    <link rel="stylesheet" href="Style/geo_map/feature_library/leaflet-sidebar.css" />
    <link rel="stylesheet" href="Style/geo_map/chart/box-heatmap.css" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-BmbxuPwQa2lc/FVzBcNJ7UAyJxM6wuqIj61tLrc4wSX0szH/Ev+nYRRuWlolflfl" crossorigin="anonymous">
   
    
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js" integrity="sha512-XQoYMqMTK8LvdxXYG3nZ448hOEQiglfqkJs1NOQV44cWnUrBc8PkAOcXy20w0vlaXaVUearIOBhiXZ5V3ynxwA==" crossorigin=""></script>
	
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"
    integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0="
    crossorigin="anonymous"></script>


    <script src="https://cdnjs.cloudflare.com/ajax/libs/underscore.js/1.9.1/underscore-min.js"></script>


    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/6.6.2/d3.min.js" integrity="sha512-L2eTGYYQqzK5YozYyUVrJKj2ZRnHE3QzV1+1yY6VXHExStF3potRZyEcD/B6sTOe04xYxB21QNLmVTQFcgwovg==" crossorigin="anonymous"></script>
    <script src="https://d3js.org/d3-queue.v3.min.js"></script>
    <script src="Scripts/geo_map/feature_library/leaflet-sidebar.js"></script>
    <script src="Scripts/geo_map/feature_library/easyPrint.js"></script>

    <script src="Scripts/geo_map/chart/box-heatmap.js"></script>
    <script src="Scripts/geo_map/chart/time_series_line_chart.js"></script>
    <script src="Scripts/geo_map/chart/animated-line-chart.js"></script>
    <script src="Scripts/geo_map/library/showMetaData.js"></script>
    <script src="Scripts/geo_map/library/geo_map_lib.js"></script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta2/dist/js/bootstrap.bundle.min.js" integrity="sha384-b5kHyXgcpbZJO/tY9Ul7kGkf1S0CWuKcCD38l8YkeH8z8QjE0GmW1gYU5S9FOnJ0" crossorigin="anonymous"></script>
    

    <style>
        .info {
            padding: 6px 8px;
            font: 14px/16px Arial, Helvetica, sans-serif;
            background: white;
            background: rgba(255,255,255,0.8);
            box-shadow: 0 0 15px rgba(0,0,0,0.2);
            border-radius: 5px;
        }
        .info h4 {
            margin: 0 0 5px;
            color: #777;
        }
        .legend {
            line-height: 18px;
            color: #555;
        }
        .legend i {
            width: 18px;
            height: 18px;
            float: left;
            margin-right: 8px;
            margin-bottom: 2px;
            opacity: 0.7;
        }

      

      body {
            padding: 0;
            margin: 0;
        }

        html, body, #map {
            height: 100%;
            font: 10pt "Helvetica Neue", Arial, Helvetica, sans-serif;
        }

        .lorem {
            font-style: italic;
            text-align: justify;
            color: #AAA;
        }

        div.tooltip {
            position: absolute;
            text-align: center;
            width: 100px;
            height: 60px;
            padding: 2px;
            font: 12px sans-serif;
            background: white;
            border: 2px solid black;
            border-radius: 5px;
            pointer-events: none;
            }

        

            .easyPrintHolder .a3CssClass { 
                background-image: url(data:image/svg+xml;utf8;base64,PD9...go=);
            }
    </style>

<style>
.area {
  fill: #00AA8D;
  opacity: 0.6;
  clip-path: url(#clip);
}

.zoom {
  cursor: move;
  fill: none;
  pointer-events: all;
}
</style>
   
</head>
<body>
    <div id="sidebar" class="leaflet-sidebar collapsed">

        <!-- nav tabs -->
        <div class="leaflet-sidebar-tabs">
            <!-- top aligned tabs -->
            <ul role="tablist">
                <li><a href="#home" role="tab"><i class="fa fa-bars active" style="padding-top: 12px;"></i></a></li>
            </ul>
        </div>

        <!-- panel content -->
        <div class="leaflet-sidebar-content">
            <div class="leaflet-sidebar-pane" id="home">
                <h1 class="leaflet-sidebar-header">
                    Shape Details
                    <span class="leaflet-sidebar-close"><i class="fa fa-caret-left" style="padding-top: 12px;"></i></span>
                </h1>

                <div style="border: 2px solid black; margin: 10px 5px;border-radius: 5px;padding: 0px 5px 10px 10px;">
                    <h3 id="segment_info">Details Information</h3>
                    <div id="meta_info_div"></div>
                </div>

            </div>
            <div id="historyHeatMap"></div>
            <div id="metric-modal"></div>
        </div>
    </div>

    <div id="mapid">
    </div>

    <div class="modal" tabindex="-1" id="loadingModal">
        <div class="modal-dialog">
          <div class="modal-content">
            <div class="modal-body">
                <div class="text-center">
                    <div class="spinner-border text-info" role="status" style="width: 100px; height:100px; margin: 35px 5px">
                        <span class="visually-hidden">Loading...</span>
                    </div>

                    <br/>
                    <p id="generalMsg" style="font-family: areal; font-size: 15px; padding: 15px 0px;"></p>
                    <span id="loading_info_details">
                        <br/>                                              
                        <div class="progress">
                            <div id="loadingProgress" class="progress-bar progress-bar-striped bg-info" role="progressbar" style="width: 0%" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
                        </div>

                        <p style="font-family: areal; font-size: 15px; padding: 15px 0px; display: none;"><span id="shapeLoadedFileCount"></span>/<span id="shapeTotalFileCount"></span> shape files loaded</p>
                    </span>

                    
                </div>
            </div>
          </div>
        </div>
    </div>

<script>

    var getParams = function (url) {
        var params = {};
        var parser = document.createElement('a');
        parser.href = url;
        var query = parser.search.substring(1);
        var vars = query.split('&');
        for (var i = 0; i < vars.length; i++) {
            var pair = vars[i].split('=');
            params[pair[0]] = decodeURIComponent(pair[1]);
        }
        return params;
    };

    var params = getParams(window.location.href);
    if(params.name)
        sessionStorage.setItem("chart_name", params.name);
    var temp_id = params.temp_id;


    var loadingModal = new bootstrap.Modal(document.getElementById('loadingModal'), {
        keyboard: false,
        backdrop: 'static',
        focus: true
    });

    var map_div = document.querySelector('#mapid');
    width_height_str = 'width: ' + (this.innerWidth-20) + "; height: " + (this.innerHeight-20);
    map_div.setAttribute('style', width_height_str);    
        
    
    map_library.initializeMap();

    
    /*
    
    animation_library.start_year = 2008;
    animation_library.end_year = 2013;
    animation_library.initializeAnimationControl('anim_1', 'Animation Panel', 'bottomright');

    
    //var layer_name = 'River IRFRoutedRunOff';
    //map_library.color_list_array[layer_name] = [ '#deebf7', '#c6dbef', '#9ecae1', '#6baed6', '#4292c6', '#2171b5', '#08519c', '#08306b', '#02214f', '#000000'];
    //map_library.color_list_array[layer_name] = [ '#ffffe5', '#f7fcb9', '#d9f0a3', '#addd8e', '#82d183', '#78c679', '#41ab5d', '#238443', '#006837', '#004529'];

    //var grades = data_library.getScaleGradesLinear(0, 120, color_list_array[layer_name].length);
    //legend_library.initializeLegendControl('legend_'+layer_name, 'Water Discharge (m3/s)', 'bottomleft', color_list_array[layer_name], legend_library.generateLegendTexts(grades));
    
    //map_library.grade_list_array[layer_name] = data_library.getScaleGradesLogarithmic(0, 550, 1, 550*2/3, map_library.default_color_list.length);
    //legend_library.legend_title_list[layer_name] = "Water Discharge (m3/s)";
    //legend_library.legend_pos_list[layer_name] = "bottomleft";    

    //map_library.drawMap(layer_name, 'jeoJSONs/bow_river_network.json', 'IRFroutedRunoff', 'COMID', 'average');
    

    var layer_name = 'River KWTRoutedRunOff';
    map_library.color_list_array[layer_name] = ['#ffffcc', '#ffeda0', '#fed976', '#feb24c', '#fc5735', '#fd8d3c', '#fc4e2a', '#e31a1c', '#bd0026', '#800026'];

    //map_library.grade_list_array[layer_name] = data_library.getScaleGradesLogarithmic(0, 550, 1, 550*2/3, map_library.default_color_list.length);
    //map_library.grade_list_array[layer_name] = [10.1, 20, 50, 60, 80, 100, 150, 200, 250];
    legend_library.legend_title_list[layer_name] = "KWT (m3/s)";
    legend_library.legend_pos_list[layer_name] = "bottomleft";   
    map_library.drawMap(layer_name, 'jeoJSONs/bow_river_network.json', 'KWTRoutedRunOff', 'COMID', 'max');



    var layer_name = 'Scalar SWE';
    map_library.color_list_array[layer_name] = [ '#ffffe5', '#f7fcb9', '#d9f0a3', '#addd8e', '#82d183', '#78c679', '#41ab5d', '#238443', '#006837', '#004529'];

    map_library.grade_list_array[layer_name] = data_library.getScaleGradesLogarithmic(0, 550, 1, 550*2/3, map_library.default_color_list.length);
    //map_library.grade_list_array[layer_name] = [10.1, 20, 50, 60, 80, 100, 150, 200, 250];
    legend_library.legend_title_list[layer_name] = "Scalar SWE (kg m-2)";
    legend_library.legend_pos_list[layer_name] = "bottomleft";   
    map_library.button_display_list[layer_name] = ["Show Total", "Show Average"];
    map_library.button_chart_type[layer_name] = ["Heatmap", "LineChart"];
    map_library.button_aggregation_type[layer_name] = ["average", "average"];
    map_library.drawMap(layer_name, 'jeoJSONs/bow_river_catchment.json', 'scalarSWE', 'HRU_ID', 'average');
    
    */
    

    //var websocket = new WebSocket("ws://206.12.95.141/AdvancedVisWebSocket");
    var websocket = new WebSocket("ws://127.0.0.1:6789/");
    websocket.onmessage = function (event) {
        d = JSON.parse(event.data);
        var output_div = document.querySelector('#output_' + d.return_div);

        //console.log(d);
        if(d.output){

            outputs = d.output.trim().replaceAll('\n','').split(';##;');
            if (outputs.length > 1){
                charts = JSON.parse(outputs[1].replaceAll("\'", "\""));

                for(var index=0; index<charts.length; index++)
                {
                    chart_name = sessionStorage.getItem("chart_name");
                    if(charts[index].to.includes(chart_name)){

                        if(charts[index].hasOwnProperty('color_list')){
                            map_library.color_list_array[charts[index].layer_name] = charts[index].color_list;
                        }
                        if(charts[index].hasOwnProperty('legend_info')){

                            if(charts[index].legend_info.hasOwnProperty('grade_list') )
                                map_library.grade_list_array[charts[index].layer_name] = charts[index].legend_info.grade_list;

                            if(charts[index].legend_info.hasOwnProperty('scale') )
                                map_library.grade_scale[charts[index].layer_name] =  charts[index].legend_info.scale;                              
                            
                            if(charts[index].legend_info.hasOwnProperty('legend_title') )
                                legend_library.legend_title_list[charts[index].layer_name] = charts[index].legend_info.legend_title;
                            
                            if(charts[index].legend_info.hasOwnProperty('legend_position') )
                                legend_library.legend_pos_list[charts[index].layer_name] = charts[index].legend_info.legend_position;

                            //map_library.color_list_array[charts[index].layer_name] = charts[index].color_list;
                        }
                        if(charts[index].hasOwnProperty('animation')){
                            animation_library.start_year = charts[index].year_from;
                            animation_library.end_year = charts[index].year_to;
                            if(charts[index].hasOwnProperty('animation_info')){
                                animation_library.initializeAnimationControl('anim_1', charts[index].animation_info.title, charts[index].animation_info.position);
                            }
                            else
                                animation_library.initializeAnimationControl('anim_1', 'Animation Panel', 'bottomright');
                        }
                        if(charts[index].hasOwnProperty('button_info')){
                            if (map_library.button_display_list[charts[index].layer_name] == undefined)
                                map_library.button_display_list[charts[index].layer_name] = [];
                            if (map_library.button_chart_type[charts[index].layer_name] == undefined)
                                map_library.button_chart_type[charts[index].layer_name] = [];
                            if (map_library.button_chart_option[charts[index].layer_name] == undefined)
                                map_library.button_chart_option[charts[index].layer_name] = [];

                            map_library.button_display_list[charts[index].layer_name].push(charts[index].display_text);
                            map_library.button_chart_type[charts[index].layer_name].push(charts[index].chart_type);
                            map_library.button_chart_option[charts[index].layer_name].push(charts[index].chart_option);
                        }
                        if(charts[index].hasOwnProperty('draw') && charts[index].draw == 1){
                            map_library.drawMap(charts[index].layer_name, charts[index].json_filename, charts[index].variable_name, 
                            charts[index].connecting_id, charts[index].aggregation_type);
                        }
                        if(charts[index].hasOwnProperty('redraw') && charts[index].redraw == 1){
                            window.location.reload();
                        }

                    }
                }

            }
            
        }
        
    };    

    websocket.onopen = function (event) {
        var obj = {'temp_id': temp_id, 'user_id': params.user_id, 'message_type': 'request'};
        websocket.send(JSON.stringify(obj));
    };

    


</script>



</body>
</html>